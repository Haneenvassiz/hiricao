{% extends "base.html" %}

{% block title %}Generate Assessment - Hirica{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="container">
        <!-- Header -->
        <div class="dashboard-header mb-4">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="dashboard-title">
                        <i class="fas fa-robot me-3"></i>Generate AI Assessment
                    </h1>
                    <p class="text-light-75 mb-0">
                        Create a comprehensive assessment for 
                        <strong>{{ application.jobseeker.user.get_full_name() }}</strong>
                    </p>
                </div>
                <div class="col-auto">
                    <a href="{{ url_for('main.view_applications', job_id=application.job_id) }}" class="btn btn-outline-light">
                        <i class="fas fa-arrow-left me-2"></i>Back to Applications
                    </a>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Candidate Info -->
            <div class="col-lg-4">
                <div class="dashboard-card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-user me-2"></i>Candidate Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="candidate-info">
                            <div class="candidate-avatar mb-3">
                                <i class="fas fa-user-circle"></i>
                                <h6 class="mt-2 mb-0">{{ application.jobseeker.user.get_full_name() }}</h6>
                                <small class="text-light-75">{{ application.jobseeker.user.email }}</small>
                            </div>
                            
                            <div class="candidate-details">
                                {% if application.jobseeker.current_position %}
                                <div class="detail-item">
                                    <i class="fas fa-briefcase me-2"></i>
                                    <span>{{ application.jobseeker.current_position }}</span>
                                </div>
                                {% endif %}
                                
                                {% if application.jobseeker.location %}
                                <div class="detail-item">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    <span>{{ application.jobseeker.location }}</span>
                                </div>
                                {% endif %}
                                
                                {% if application.jobseeker.experience_years %}
                                <div class="detail-item">
                                    <i class="fas fa-clock me-2"></i>
                                    <span>{{ application.jobseeker.experience_years }} years experience</span>
                                </div>
                                {% endif %}
                                
                                {% if application.jobseeker.linkedin_url %}
                                <div class="detail-item">
                                    <i class="fab fa-linkedin me-2"></i>
                                    <a href="{{ application.jobseeker.linkedin_url }}" target="_blank" class="text-primary">
                                        LinkedIn Profile
                                    </a>
                                </div>
                                {% endif %}
                                
                                {% if application.jobseeker.github_url %}
                                <div class="detail-item">
                                    <i class="fab fa-github me-2"></i>
                                    <a href="{{ application.jobseeker.github_url }}" target="_blank" class="text-primary">
                                        GitHub Profile
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                            
                            {% if application.cover_letter %}
                            <div class="mt-3">
                                <h6 class="text-white">Cover Letter</h6>
                                <div class="cover-letter-preview">
                                    {{ application.cover_letter[:200] }}
                                    {% if application.cover_letter|length > 200 %}...{% endif %}
                                </div>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="showFullCoverLetter()">
                                    Read Full Letter
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Job Info -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-briefcase me-2"></i>Job Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <h6 class="text-white">{{ application.job.title }}</h6>
                        <div class="job-meta mb-3">
                            <span class="badge bg-secondary me-2">{{ application.job.employment_type }}</span>
                            <span class="badge bg-info">{{ application.job.experience_level }}</span>
                        </div>
                        
                        <div class="detail-item">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            <span>{{ application.job.location }}</span>
                        </div>
                        
                        {% if application.job.get_skills_list() %}
                        <div class="mt-3">
                            <h6 class="text-white small">Required Skills</h6>
                            <div class="skills-list">
                                {% for skill in application.job.get_skills_list()[:5] %}
                                <span class="skill-badge">{{ skill }}</span>
                                {% endfor %}
                                {% if application.job.get_skills_list()|length > 5 %}
                                <span class="text-light-75">+{{ application.job.get_skills_list()|length - 5 }} more</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Assessment Generation -->
            <div class="col-lg-8">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-magic me-2"></i>AI Assessment Generation
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="assessment-preview" id="assessmentPreview" style="display: none;">
                            <!-- Generated assessment will appear here -->
                        </div>
                        
                        <div class="generation-form" id="generationForm">
                            <div class="mb-4">
                                <h6 class="text-white">What the AI will consider:</h6>
                                <ul class="ai-considerations">
                                    <li><i class="fas fa-check text-success me-2"></i>Job requirements and responsibilities</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Required skills and experience level</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Industry best practices</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Role-specific technical knowledge</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Problem-solving scenarios</li>
                                </ul>
                            </div>
                            
                            <div class="mb-4">
                                <h6 class="text-white">Assessment Components</h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="assessment-component">
                                            <i class="fas fa-question-circle"></i>
                                            <div>
                                                <strong>Multiple Choice Questions</strong>
                                                <p class="small text-light-75 mb-0">Technical knowledge and concepts</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="assessment-component">
                                            <i class="fas fa-edit"></i>
                                            <div>
                                                <strong>Text-based Questions</strong>
                                                <p class="small text-light-75 mb-0">Problem-solving and scenarios</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="assessment-component">
                                            <i class="fas fa-code"></i>
                                            <div>
                                                <strong>Coding Challenges</strong>
                                                <p class="small text-light-75 mb-0">Practical programming tasks</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="assessment-component">
                                            <i class="fas fa-project-diagram"></i>
                                            <div>
                                                <strong>Project Assignments</strong>
                                                <p class="small text-light-75 mb-0">Real-world application tasks</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h6 class="text-white">Anti-Cheat Features</h6>
                                <div class="anti-cheat-features">
                                    <div class="feature-item">
                                        <i class="fas fa-video text-primary me-2"></i>
                                        <span>Webcam monitoring and face detection</span>
                                    </div>
                                    <div class="feature-item">
                                        <i class="fas fa-eye text-primary me-2"></i>
                                        <span>Tab switching and focus detection</span>
                                    </div>
                                    <div class="feature-item">
                                        <i class="fas fa-shield-alt text-primary me-2"></i>
                                        <span>Copy-paste and right-click prevention</span>
                                    </div>
                                    <div class="feature-item">
                                        <i class="fas fa-expand text-primary me-2"></i>
                                        <span>Full-screen mode enforcement</span>
                                    </div>
                                </div>
                            </div>
                            
                            <form method="POST" class="generation-options">
                                <div class="mb-3">
                                    <label class="form-label">Assessment Focus (Optional)</label>
                                    <textarea class="form-control" name="focus_areas" rows="3" 
                                              placeholder="Specify any particular areas you want the assessment to focus on..."></textarea>
                                </div>
                                
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Difficulty Level</label>
                                        <select class="form-select" name="difficulty">
                                            <option value="auto" selected>Auto (based on experience level)</option>
                                            <option value="beginner">Beginner</option>
                                            <option value="intermediate">Intermediate</option>
                                            <option value="advanced">Advanced</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Estimated Duration</label>
                                        <select class="form-select" name="duration">
                                            <option value="60">1 hour</option>
                                            <option value="90" selected>1.5 hours</option>
                                            <option value="120">2 hours</option>
                                            <option value="180">3 hours</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="generation-actions">
                                    <button type="submit" class="btn btn-primary btn-lg me-3" id="generateBtn">
                                        <i class="fas fa-magic me-2"></i>Generate Assessment
                                        <span class="spinner-border spinner-border-sm ms-2" style="display: none;" id="generateSpinner"></span>
                                    </button>
                                    <button type="button" class="btn btn-outline-light btn-lg" onclick="showManualCreation()">
                                        <i class="fas fa-edit me-2"></i>Create Manually
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cover Letter Modal -->
<div class="modal fade" id="coverLetterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white">Cover Letter</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="cover-letter-full text-light-75">
                    {{ application.cover_letter }}
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showFullCoverLetter() {
    const modal = new bootstrap.Modal(document.getElementById('coverLetterModal'));
    modal.show();
}

function showManualCreation() {
    if (confirm('Create assessment manually? This will skip AI generation.')) {
        window.location.href = '/recruiter/assessment/create/manual?application_id={{ application.id }}';
    }
}

// Handle form submission
document.querySelector('.generation-options').addEventListener('submit', function(e) {
    const btn = document.getElementById('generateBtn');
    const spinner = document.getElementById('generateSpinner');
    
    btn.disabled = true;
    spinner.style.display = 'inline-block';
    
    // Update button text
    btn.innerHTML = '<i class="fas fa-magic me-2"></i>Generating Assessment... <span class="spinner-border spinner-border-sm ms-2"></span>';
});

// Simulate progress updates (in real implementation, this would be WebSocket updates)
let progressStep = 0;
const progressSteps = [
    "Analyzing job requirements...",
    "Generating technical questions...",
    "Creating coding challenges...",
    "Setting up anti-cheat rules...",
    "Finalizing assessment..."
];

function updateProgress() {
    if (progressStep < progressSteps.length) {
        // In a real implementation, you'd show progress updates
        console.log(progressSteps[progressStep]);
        progressStep++;
        setTimeout(updateProgress, 1000);
    }
}

// Auto-save form data
function saveFormData() {
    const formData = new FormData(document.querySelector('.generation-options'));
    const data = Object.fromEntries(formData);
    localStorage.setItem('assessmentGeneration', JSON.stringify(data));
}

// Restore form data
function restoreFormData() {
    const saved = localStorage.getItem('assessmentGeneration');
    if (saved) {
        const data = JSON.parse(saved);
        Object.keys(data).forEach(key => {
            const element = document.querySelector(`[name="${key}"]`);
            if (element) {
                element.value = data[key];
            }
        });
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    restoreFormData();
    
    // Auto-save on changes
    document.querySelector('.generation-options').addEventListener('change', saveFormData);
    document.querySelector('.generation-options').addEventListener('input', saveFormData);
});
</script>
{% endblock %}
